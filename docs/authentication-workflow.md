# **User Authentication** 

___

### High Level Overview

**1.** User inputs username and password, this information is sent to the backend.


**2.** Backend retrieves a stored user that matches the requested username


**3.** The provided password is hashed (12 strength BCrypt), and compared to the stored hashed password.


**4.** If the user input credentials match what is stored in the database, a JWT token is generated, then sent back to the user.


**5.** Further requests will include the JWT, and protected endpoints will check the JWT for validity or expiration.


**6.** If the JWT is valid, the request proceeds without needing to input the username and password. If the request is not valid, access is denied.

___

### Detailed


___


All Kipa API's, except `/login`, and `/register`, will require authentication. The first time a user attempts to reach any authorized endpoint, they will be prompted to enter their login credentials.

The credentials that the user enters will be sent to `@POST /login` in `UserController`, in the form of a `User` object, containing a username and password. While users are prompted to include an email in registration, this value is _not_ used in the login process.

The `User` object will be passed to `UserService.verifyUser()` to be authenticated.

___

Within `UserService.verifyUser()`, the users username and password are passed to the `authenticate()` function of `AuthenticationManager` in the form of a `UsernamePasswordAuthenticationToken`.

* **Note** -  `UsernamePasswordAuthenticationToken` does NOT create a JWT token, this token is essentially just a data structure comprised of the users credentials.


`AuthenticationManager` then delegates authentication to `DaoAuthenticationProvider`, which handles the actual credential verification. 

If authentication fails, an exception is thrown. 

If authentication succeeds, `JWTService.generateToken()` is called to generate a JWT.

___

`JWTService` generates a `SecretKey`, using the HMAC-SHA256 algorithm, which is then Base64-encoded. 


`JWTService.generateToken()` is responsible for the creation of the token itself. A JWT is a Base64-encoded string made up of three parts:
* **Header** --> Algorithim and token type
* **Payload** --> Claims (username, issued-at, expiration, etc..)
* **Signature** --> Generated by signing the header and payload with the SecretKey

**Note** - JWT's are encoded, _not_ encrypted. The SecretKey signature ensures it has not been tampered with, but the data inside is readable unless seperately encrypted.

The JWT will be sent back to the user to be used for future authentication requests.

By default, Kipa will use `JWTFilter` to prioritize JWT's for future authentication requests. JWT's will still undergo a verification process to ensure it has not been tampered with or has not expired (expiration is currently set at 100 minutes). If a valid JWT is detected, the user will not be prompted to enter their login credentials. 

More information regarding `JWTFilter` is available in `/security-configuration`.


